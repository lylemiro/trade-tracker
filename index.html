<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Progress Tracker</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- Shepherd.js for Guided Tour -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
    <!-- Tone.js for sound synthesis -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        /* Custom styles to complement Bootstrap */
        :root {
            --bs-body-font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --positive-color: #198754;
            --negative-color: #dc3545;
        }

        [data-bs-theme="dark"] {
            --positive-color: #20c997;
            --negative-color: #fd7e14;
        }

        .positive { color: var(--positive-color) !important; }
        .negative { color: var(--negative-color) !important; }

        .card-header {
            cursor: grab;
        }
        .card-header:active {
            cursor: grabbing;
        }
        
        /* Collapse icon transition */
        .collapse-icon {
            transition: transform 0.3s ease;
        }
        [aria-expanded="false"] .collapse-icon {
            transform: rotate(-90deg);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        #tradeHistoryOutput {
            max-height: 400px;
            overflow-y: auto;
        }
        .trade-entry:not(:last-child) {
            border-bottom: 1px dashed var(--bs-border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Shepherd.js tour styling */
        .shepherd-element {
            max-width: 175px; /* Default small width for tour steps */
        }
        .shepherd-has-title .shepherd-content .shepherd-header {
            background: #e6e6e6;
            padding: 9px;
        }
        .shepherd-footer {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            display: flex;
            justify-content: flex-end;
            padding: 0 9px 9px;
        }
        .shepherd-title {
            font-size: 11px !important;
            font-weight: bold !important;
            color: #333;
        }
        .shepherd-text {
            font-size: 10px !important;
            color: #333;
        }
        .shepherd-button {
            background: var(--bs-primary);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            font-size: 10px;
            border-radius: 0.25rem;
            margin-right: 0.5rem;
        }
        .shepherd-button:hover {
            opacity: 0.9;
        }
        .shepherd-button.shepherd-button-secondary {
            background: var(--bs-secondary);
        }

        /* NEW: Override for the first welcome step to make it standard size */
        .shepherd-step-welcome.shepherd-element {
            max-width: 350px; /* A more standard width */
        }
        .shepherd-step-welcome .shepherd-title {
            font-size: 1rem !important;
        }
        .shepherd-step-welcome .shepherd-text {
            font-size: 0.875rem !important;
        }
        .shepherd-step-welcome .shepherd-button {
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
        }
        
        /* Card title padding adjustment */
        .card h2, .card h3 {
            padding-bottom: 8px; /* Reduced from 10px */
        }
        
        /* Chart toggle buttons */
        .chart-toggle-buttons .btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
    </style>
</head>
<body>
    <!-- --- HTML STRUCTURE (Bootstrap) --- -->
    <div class="container-fluid p-3 p-lg-4">
        <header class="p-3 mb-4 rounded-3 text-bg-primary shadow-sm">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Trade Progress Dashboard</h1>
                <div>
                    <button class="btn btn-light rounded-pill me-2" id="startTourButton">
                        <i class="bi bi-question-circle-fill"></i> Help
                    </button>
                    <button class="btn btn-outline-light rounded-pill" id="themeToggle">
                        <i class="bi bi-moon-stars-fill"></i> Toggle Theme
                    </button>
                </div>
            </div>
        </header>

        <div class="row g-4" id="card-container">
            <!-- Row 1: High-Level Summaries -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="calculatedGoalsCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseCalculatedGoals" role="button" aria-expanded="true" aria-controls="collapseCalculatedGoals">
                        <h2 class="h5 mb-0"><i class="bi bi-bullseye me-2"></i>Calculated Goals</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseCalculatedGoals">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2"><span>Target Balance:</span> <strong id="goalTargetBalance"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Total Gains:</span> <strong id="goalTotalGains" class="positive"></strong></div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2" title="Based on your average daily profit since your first trade.">
                                <span>Days to Target (Linear):</span> <strong id="goalDaysRemainingLinear"></strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2" title="Based on your selected projection method and trades per day.">
                                <span>Days to Target (Projection):</span> <strong id="goalDaysRemainingProjection"></strong>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between" title="The average trade size you need to use to hit your monthly income target, based on your historical ROI and trades per day.">
                                <span>Required Avg. Trade Size:</span> <strong id="goalRequiredAvgTradeSize" class="text-info"></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="gainsSummaryCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseGains" role="button" aria-expanded="true" aria-controls="collapseGains">
                        <h2 class="h5 mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Gains Summary</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseGains">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2"><span>Current Gain (<span class="currency-symbol">USDT</span>):</span> <strong id="currentGain"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Current Gain (₱):</span> <strong id="currentGainPhp"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Current ROI:</span> <strong id="currentRoi"></strong></div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2"><span>Gain Difference (<span class="currency-symbol">USDT</span>):</span> <strong id="gainDifference"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Trade Amount Growth:</span> <strong id="tradeAmountGrowth"></strong></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="balanceOverviewCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseBalance" role="button" aria-expanded="true" aria-controls="collapseBalance">
                        <h2 class="h5 mb-0"><i class="bi bi-wallet2 me-2"></i>Balance Overview</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseBalance">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2"><span>Previous Balance:</span> <strong id="previousBalanceCombined"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Calculated Balance:</span> <strong id="calculatedBalanceCombined"></strong></div>
                            <hr>
                            <div class="mb-2">
                                <label for="actualCurrentBalance" class="form-label">Actual Current Balance (<span class="currency-symbol">USDT</span>)</label>
                                <input type="number" id="actualCurrentBalance" value="0" step="0.00000001" class="form-control">
                            </div>
                            <div class="d-flex justify-content-between"><strong>Discrepancy:</strong> <strong id="discrepancyCombined"></strong></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Analytics & Charts -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="streakAnalyticsCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseStreaks" role="button" aria-expanded="true" aria-controls="collapseStreaks">
                        <h2 class="h5 mb-0"><i class="bi bi-trophy me-2"></i>Streak Analytics</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseStreaks">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2"><span>Current Win Streak:</span> <strong id="currentWinStreak" class="positive"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Longest Win Streak:</span> <strong id="longestWinStreak" class="positive"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Current Loss Streak:</span> <strong id="currentLossStreak" class="negative"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Longest Loss Streak:</span> <strong id="longestLossStreak" class="negative"></strong></div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2"><span>Total Wins / Losses:</span> <strong><span id="totalWins" class="positive"></span> / <span id="totalLosses" class="negative"></span></strong></div>
                            <div class="d-flex justify-content-between"><span>Win Rate:</span> <strong id="winRate"></strong></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- NEW: Consolidated Chart Card 1 -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="hubChartCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseHubChart" role="button" aria-expanded="true" aria-controls="collapseHubChart">
                        <h2 class="h5 mb-0"><i class="bi bi-pie-chart me-2"></i>Performance Hub</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseHubChart">
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="hubChartCanvas"></canvas>
                            </div>
                             <div class="btn-group w-100 mt-2 chart-toggle-buttons" role="group" aria-label="Hub Chart Toggles">
                                <button type="button" class="btn btn-outline-primary" data-chart-card="hub" data-chart-type="cumulative">Balance</button>
                                <button type="button" class="btn btn-outline-primary" data-chart-card="hub" data-chart-type="projection">Projection</button>
                                <button type="button" class="btn btn-outline-primary" data-chart-card="hub" data-chart-type="discrepancy">Discrepancy</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Consolidated Chart Card 2 -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="periodicChartCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapsePeriodicChart" role="button" aria-expanded="true" aria-controls="collapsePeriodicChart">
                        <h2 class="h5 mb-0"><i class="bi bi-calendar-event me-2"></i>Periodic Analysis</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapsePeriodicChart">
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="periodicChartCanvas"></canvas>
                            </div>
                             <div class="btn-group w-100 mt-2 chart-toggle-buttons" role="group" aria-label="Periodic Chart Toggles">
                                <button type="button" class="btn btn-outline-primary" data-chart-card="periodic" data-chart-type="monthlyPnl">Monthly PNL</button>
                                <button type="button" class="btn btn-outline-primary" data-chart-card="periodic" data-chart-type="dailyPnl">Daily PNL</button>
                                <button type="button" class="btn btn-outline-primary" data-chart-card="periodic" data-chart-type="dailyRoi">Daily ROI</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: Consolidated Chart Card 3 -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="metricsChartCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseMetricsChart" role="button" aria-expanded="true" aria-controls="collapseMetricsChart">
                        <h2 class="h5 mb-0"><i class="bi bi-graph-up me-2"></i>Metric Breakdowns</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseMetricsChart">
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="metricsChartCanvas"></canvas>
                            </div>
                            <div class="btn-group w-100 mt-2 chart-toggle-buttons" role="group" aria-label="Metrics Chart Toggles">
                                <button type="button" class="btn btn-outline-primary" data-chart-card="metrics" data-chart-type="byAsset">By Asset</button>
                                <button type="button" class="btn btn-outline-primary" data-chart-card="metrics" data-chart-type="avgWinLoss">Win/Loss</button>
                                <button type="button" class="btn btn-outline-primary" data-chart-card="metrics" data-chart-type="monthlyVolume">Volume</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 3: Schedule & Settings -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="schedulePlannerCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseSchedule" role="button" aria-expanded="true" aria-controls="collapseSchedule">
                        <h2 class="h5 mb-0"><i class="bi bi-calendar-week me-2"></i>Trading Schedule</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseSchedule">
                        <div class="card-body">
                            <textarea id="schedulePlannerInput" class="form-control" rows="5" placeholder="e.g., Monday: 9 AM - 12 PM, Focus on BTC/USDT..."></textarea>
                            <small class="form-text text-muted">Your schedule will auto-save.</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="financialGoalsCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseGoals" role="button" aria-expanded="true" aria-controls="collapseGoals">
                        <h2 class="h5 mb-0"><i class="bi bi-gear me-2"></i>Goals & Settings</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseGoals">
                        <div class="card-body">
                            <h6 class="text-muted">Core Inputs</h6>
                            <div class="mb-2"><label>Trading Currency:</label>
                                <select id="selectedCryptoSelect" class="form-select form-select-sm">
                                    <option>Loading currencies...</option>
                                </select>
                            </div>
                            <div class="mb-2"><label>Crypto/PHP Rate:</label><input type="number" id="cryptoPhpRate" class="form-control form-control-sm"></div>
                            <div class="mb-2"><label>Target Monthly Income (₱):</label><input type="number" id="targetMonthlyIncomePhp" class="form-control form-control-sm"></div>
                            <div class="mb-3"><label>Starting Balance (<span class="currency-symbol">USDT</span>):</label><input type="number" id="startingBalance" class="form-control form-control-sm"></div>
                            <hr>
                            <h6 class="text-muted">Volume Target</h6>
                            <div class="mb-2"><label>Target Trading Volume (<span class="currency-symbol">USDT</span>):</label><input type="number" id="targetTradingVolume" class="form-control form-control-sm"></div>
                            <div class="d-flex justify-content-between"><span>Days Remaining (Volume):</span> <strong id="daysRemainingVolumeTarget"></strong></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="projectionSettingsCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseProjections" role="button" aria-expanded="true" aria-controls="collapseProjections">
                        <h2 class="h5 mb-0"><i class="bi bi-binoculars me-2"></i>Projection Settings</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseProjections">
                        <div class="card-body">
                            <div class="mb-2"><label>Method:</label><select id="projectionMethodSelect" class="form-select form-select-sm"><option value="percent">By % Gain Per Trade</option><option value="fixedRoi">By Fixed Trade Amt & ROI</option></select></div>
                            <div class="mb-2"><label>Trades Per Day:</label><input type="number" id="tradesPerDayInput" class="form-control form-control-sm"></div>
                            <div class="mb-3"><label>Projection Period (Days):</label><input type="number" id="projectionPeriodDaysInput" class="form-control form-control-sm"></div>
                            <div id="percentProjectionInputs"><hr><h6 class="text-muted">% Gain Details</h6><div class="mb-2"><label>Projected Gain Per Trade (%):</label><input type="number" id="projectedGainPerTradeInput" class="form-control form-control-sm"></div></div>
                            <div id="fixedRoiProjectionInputs" style="display: none;"><hr><h6 class="text-muted">Fixed Amount Details</h6><div class="mb-2"><label>Projected Trade Amount (<span class="currency-symbol">USDT</span>):</label><input type="number" id="projectedTradeAmountInput" class="form-control form-control-sm"></div><div class="mb-2"><label>Projected ROI Per Trade (%):</label><input type="number" id="projectedRoiPerTradeInput" class="form-control form-control-sm"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 4: Input & History (Lowest Priority) -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="dataInputCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseDataInput" role="button" aria-expanded="true" aria-controls="collapseDataInput">
                        <h2 class="h5 mb-0"><i class="bi bi-file-earmark-plus me-2"></i>Input & Data</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseDataInput">
                        <div class="card-body">
                            <textarea id="tradeDataInput" class="form-control mb-2" rows="8"></textarea>
                            <div class="d-flex gap-2 mb-2">
                                <button id="processDataButton" class="btn btn-primary w-75">Process Trades</button>
                                <button id="clearDataInputButton" class="btn btn-outline-secondary w-25">Clear</button>
                            </div>
                            <small id="dataInputMessage" class="form-text text-muted d-block min-vh-2"></small>
                            <div class="d-flex gap-2 mt-2">
                                <button id="importDataButton" class="btn btn-secondary w-50">Import Data</button>
                                <button id="exportDataButton" class="btn btn-secondary w-50">Export Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="processedHistoryCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseHistory" role="button" aria-expanded="true" aria-controls="collapseHistory">
                        <h3 class="h5 mb-0"><i class="bi bi-list-ol me-2"></i>Processed Trade History</h3>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseHistory">
                        <div class="card-body">
                            <div id="tradeHistoryOutput" class="p-2 border rounded bg-light-subtle"><p class="text-center text-muted m-0">No trade data processed yet.</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reset Button -->
            <div class="col-12 text-center">
                <button class="btn btn-danger" id="resetDataButtonBottom"><i class="bi bi-trash me-2"></i>Reset All Data</button>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal fade" id="resetConfirmationModal" tabindex="-1" aria-labelledby="resetModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="resetModalLabel">Confirm Reset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to reset all data? This action cannot be undone. All settings and trade history will be permanently deleted.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmResetButton">Yes, Reset Data</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <script>
        /* --- JAVASCRIPT LOGIC (script.js) --- */
        // --- GLOBAL VARIABLES (Accessible throughout the script) ---
        let hubChart, periodicChart, metricsChart; // NEW: Consolidated chart instances
        let tour;
        let coinList = []; // To store the fetched list of coins
        let resetModal; // Variable to hold the modal instance

        const DEFAULT_APP_SETTINGS = { cryptoPhpRate: 58.90, targetMonthlyIncomePhp: 50000, startingBalance: 301, projectedGainPerTrade: 1, tradesPerDay: 2, projectionPeriodDays: 90, projectedTradeAmount: 3.00, projectedRoiPerTrade: 70, selectedProjectionMethod: 'percent', theme: 'light', schedulePlanner: '', targetTradingVolume: 300, selectedCrypto: 'USDT' };
        const DEFAULT_BALANCE_DATA = { previousBalance: 0, calculatedBalance: 0, actualBalance: 0 };
        const DEFAULT_LAST_TRADE_STATS = { currentGain: 0, currentRoi: 0, previousGain: 0, lastTradeAmount: 0, previousTradeAmount: 0 };
        const DEFAULT_CARD_STATES = {};
        // NEW: State for active chart views
        const DEFAULT_ACTIVE_CHART_VIEWS = { hub: 'cumulative', periodic: 'monthlyPnl', metrics: 'byAsset' };

        let tradeHistory = [], appSettings = { ...DEFAULT_APP_SETTINGS }, balanceData = { ...DEFAULT_BALANCE_DATA }, lastTradeStats = { ...DEFAULT_LAST_TRADE_STATS }, cardStates = { ...DEFAULT_CARD_STATES }, discrepancyHistory = [], cumulativeBalanceHistory = [], projectedGrowthHistory = [], activeChartViews = {...DEFAULT_ACTIVE_CHART_VIEWS};

        // --- Helper Functions ---
        const cleanLine = (line) => line.replace(/[\u00A0\u200B-\u200D\uFEFF]/g, ' ').replace(/\s+/g, ' ').trim();
        const formatCurrency = (amount, currency = appSettings.selectedCrypto) => {
            if (isNaN(amount)) return `0.00 ${currency}`;
            const precision = currency === 'BTC' ? 8 : (currency === 'ETH' ? 6 : 2);
            return `${amount.toFixed(precision)} ${currency}`;
        }
        const formatPhp = (amount) => `₱${amount.toFixed(2)}`;
        const formatDecimalPercentage = (value) => `${value.toFixed(2)} %`;
        const formatPercentage = (value) => `${value.toFixed(2)}%`;
        const formatCombinedCurrency = (cryptoAmount, rate) => `${formatCurrency(cryptoAmount)} (₱${(cryptoAmount * rate).toFixed(2)})`;
        const formatDays = (days) => isFinite(days) && days > 0 ? `${days.toFixed(2)} days` : 'N/A';

        // --- Sound Synthesis with Tone.js ---
        let soundsReady = false;
        let popSoundWin, popSoundLoss;

        function initializeSounds() {
            if (soundsReady) return;
            // A synth for a higher, positive notification "pop"
            popSoundWin = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.001, decay: 0.1, sustain: 0, release: 0.1 }
            }).toDestination();
            popSoundWin.volume.value = -6; // Lower the volume to be less intrusive

            // A synth for a lower, neutral/negative notification "pop"
            popSoundLoss = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: { attack: 0.001, decay: 0.15, sustain: 0, release: 0.1 }
            }).toDestination();
            popSoundLoss.volume.value = -6;

            soundsReady = true;
        }

        async function playSound(type) {
            // Audio context must be started by a user gesture.
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }
            if (!soundsReady) {
                initializeSounds();
            }

            const now = Tone.now();
            if (type === 'win') {
                // Play a short, high-pitched pop
                popSoundWin.triggerAttackRelease("A5", "32n", now);
            } else if (type === 'loss') {
                // Play a slightly lower pop
                popSoundLoss.triggerAttackRelease("A4", "32n", now);
            }
        }

        function toggleProjectionInputs(method) {
            document.getElementById('percentProjectionInputs').style.display = method === 'percent' ? 'block' : 'none';
            document.getElementById('fixedRoiProjectionInputs').style.display = method === 'fixedRoi' ? 'block' : 'none';
        }
        
        function updatePlaceholderText() {
            const currency = appSettings.selectedCrypto;
            const pnlExample = currency === 'BTC' ? '+0.00015' : (currency === 'ETH' ? '+0.005' : '+2.36');
            const volExample = currency === 'BTC' ? '0.0005' : (currency === 'ETH' ? '0.05' : '3.19');
            const placeholder = `Paste your detailed trade history here.
The format must match the selected currency.

Example for ${currency}:

BTC/USDT
Order No. 579579592027456
Time 2025-07-22 19:04
PNL ${pnlExample} ${currency}
ROI ≈ 73.98 %
Effective trading volume ${volExample} ${currency}`;
            document.getElementById('tradeDataInput').placeholder = placeholder;
        }

        // --- State Management ---
        function saveState() {
            localStorage.setItem('tradeTrackerData', JSON.stringify({ tradeHistory, appSettings, balanceData, lastTradeStats, cardStates, discrepancyHistory, cumulativeBalanceHistory, projectedGrowthHistory, activeChartViews }));
        }

        function loadState(dataToLoad = null) {
            const data = dataToLoad || (JSON.parse(localStorage.getItem('tradeTrackerData')) || {});
            tradeHistory = data.tradeHistory || [];
            appSettings = { ...DEFAULT_APP_SETTINGS, ...(data.appSettings || {}) };
            balanceData = { ...DEFAULT_BALANCE_DATA, ...(data.balanceData || {}) };
            lastTradeStats = { ...DEFAULT_LAST_TRADE_STATS, ...(data.lastTradeStats || {}) };
            cardStates = data.cardStates || {};
            discrepancyHistory = data.discrepancyHistory || [];
            cumulativeBalanceHistory = data.cumulativeBalanceHistory || [];
            projectedGrowthHistory = data.projectedGrowthHistory || [];
            activeChartViews = { ...DEFAULT_ACTIVE_CHART_VIEWS, ...(data.activeChartViews || {}) };
        }

        function updateUiFromState() {
            document.getElementById('selectedCryptoSelect').value = appSettings.selectedCrypto;
            document.getElementById('cryptoPhpRate').value = appSettings.cryptoPhpRate;
            document.getElementById('targetMonthlyIncomePhp').value = appSettings.targetMonthlyIncomePhp;
            document.getElementById('startingBalance').value = appSettings.startingBalance;
            document.getElementById('targetTradingVolume').value = appSettings.targetTradingVolume;
            document.getElementById('projectionMethodSelect').value = appSettings.selectedProjectionMethod;
            document.getElementById('tradesPerDayInput').value = appSettings.tradesPerDay;
            document.getElementById('projectionPeriodDaysInput').value = appSettings.projectionPeriodDays;
            document.getElementById('projectedGainPerTradeInput').value = appSettings.projectedGainPerTrade;
            document.getElementById('projectedTradeAmountInput').value = appSettings.projectedTradeAmount;
            document.getElementById('projectedRoiPerTradeInput').value = appSettings.projectedRoiPerTrade;
            document.getElementById('schedulePlannerInput').value = appSettings.schedulePlanner;
            
            document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = appSettings.selectedCrypto);
            document.getElementById('actualCurrentBalance').value = balanceData.actualBalance;
            document.documentElement.setAttribute('data-bs-theme', appSettings.theme);
            toggleProjectionInputs(appSettings.selectedProjectionMethod);

            // NEW: Update active state of chart toggle buttons
            for (const card in activeChartViews) {
                const type = activeChartViews[card];
                const buttons = document.querySelectorAll(`.chart-toggle-buttons .btn[data-chart-card="${card}"]`);
                buttons.forEach(btn => {
                    if (btn.dataset.chartType === type) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }

            for (const cardId in cardStates) {
                const card = document.getElementById(cardId);
                const collapseTarget = card?.querySelector('.collapse');
                if (card && collapseTarget) {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseTarget);
                    if (cardStates[cardId] === 'collapsed') bsCollapse.hide();
                    else bsCollapse.show();
                }
            }
        }

        function calculateStreaks(filteredTrades) {
            let currentWinStreak = 0, longestWinStreak = 0, currentLossStreak = 0, longestLossStreak = 0;
            filteredTrades.forEach(trade => {
                if (trade.pnl >= 0) {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    if (currentWinStreak > longestWinStreak) longestWinStreak = currentWinStreak;
                } else {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    if (currentLossStreak > longestLossStreak) longestLossStreak = currentLossStreak;
                }
            });
            return { currentWinStreak, longestWinStreak, currentLossStreak, longestLossStreak };
        }

        function calculateProjections(targetBalance, filteredTrades) {
            projectedGrowthHistory = [];
            let projectedBalance = balanceData.calculatedBalance;
            const today = new Date();

            let daysToTarget = 0;
            let reachedTarget = false;
            const maxProjectionCheck = 365 * 5; 

            for (let i = 0; i < maxProjectionCheck; i++) {
                let currentDayBalance = projectedBalance;
                if (i < appSettings.projectionPeriodDays) {
                    const futureDate = new Date(today);
                    futureDate.setDate(today.getDate() + i);
                     for (let j = 0; j < appSettings.tradesPerDay; j++) {
                        if (appSettings.selectedProjectionMethod === 'percent') {
                            currentDayBalance += currentDayBalance * (appSettings.projectedGainPerTrade / 100);
                        } else {
                            currentDayBalance += appSettings.projectedTradeAmount * (appSettings.projectedRoiPerTrade / 100);
                        }
                    }
                    projectedGrowthHistory.push({ time: futureDate.toISOString(), balance: currentDayBalance });
                }

                if (!reachedTarget) {
                    for (let j = 0; j < appSettings.tradesPerDay; j++) {
                        if (appSettings.selectedProjectionMethod === 'percent') {
                            projectedBalance += projectedBalance * (appSettings.projectedGainPerTrade / 100);
                        } else {
                            projectedBalance += appSettings.projectedTradeAmount * (appSettings.projectedRoiPerTrade / 100);
                        }
                        if (projectedBalance >= targetBalance) {
                            daysToTarget = i + ((j + 1) / appSettings.tradesPerDay);
                            reachedTarget = true;
                            break;
                        }
                    }
                }
                
                if (i >= appSettings.projectionPeriodDays && reachedTarget) break;
            }

            return { daysToTarget: reachedTarget ? daysToTarget : Infinity };
        }


        // --- Core Logic ---
        async function updateAllMetrics() {
            // Update settings from UI
            const newCrypto = document.getElementById('selectedCryptoSelect').value;
            if (appSettings.selectedCrypto !== newCrypto) {
                appSettings.selectedCrypto = newCrypto;
                await fetchExchangeRate();
            }
            
            appSettings.cryptoPhpRate = parseFloat(document.getElementById('cryptoPhpRate').value) || 0;
            appSettings.targetMonthlyIncomePhp = parseFloat(document.getElementById('targetMonthlyIncomePhp').value) || 0;
            appSettings.startingBalance = parseFloat(document.getElementById('startingBalance').value) || 0;
            appSettings.projectedGainPerTrade = parseFloat(document.getElementById('projectedGainPerTradeInput').value) || 0;
            appSettings.tradesPerDay = parseInt(document.getElementById('tradesPerDayInput').value) || 0;
            appSettings.projectionPeriodDays = parseInt(document.getElementById('projectionPeriodDaysInput').value) || 0;
            appSettings.projectedTradeAmount = parseFloat(document.getElementById('projectedTradeAmountInput').value) || 0;
            appSettings.projectedRoiPerTrade = parseFloat(document.getElementById('projectedRoiPerTradeInput').value) || 0;
            appSettings.targetTradingVolume = parseFloat(document.getElementById('targetTradingVolume').value) || 0;
            balanceData.actualBalance = parseFloat(document.getElementById('actualCurrentBalance').value) || 0;

            document.querySelectorAll('.currency-symbol').forEach(el => el.textContent = appSettings.selectedCrypto);
            updatePlaceholderText();

            const filteredTrades = tradeHistory.filter(t => t.currency === appSettings.selectedCrypto);
            
            let totalPnL = filteredTrades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
            balanceData.calculatedBalance = appSettings.startingBalance + totalPnL;

            const discrepancy = balanceData.actualBalance - balanceData.calculatedBalance;
            if (filteredTrades.length > 0) {
                discrepancyHistory.push({ time: new Date().toISOString(), value: discrepancy });
                if (discrepancyHistory.length > 100) discrepancyHistory.shift();
            }
            
            const latestTrade = filteredTrades.length > 0 ? filteredTrades[filteredTrades.length - 1] : {};
            const secondLatestTrade = filteredTrades.length > 1 ? filteredTrades[filteredTrades.length - 2] : {};
            
            lastTradeStats.currentGain = latestTrade.pnl || 0;
            lastTradeStats.currentRoi = latestTrade.roi || 0;
            lastTradeStats.lastTradeAmount = latestTrade.effectiveVolume || 0;
            lastTradeStats.previousGain = secondLatestTrade.pnl || 0;
            lastTradeStats.previousTradeAmount = secondLatestTrade.effectiveVolume || 0;

            const gainDifference = lastTradeStats.currentGain - lastTradeStats.previousGain;
            const tradeAmountGrowth = lastTradeStats.lastTradeAmount - lastTradeStats.previousTradeAmount;

            // --- Goal Calculations ---
            const monthlyTargetCrypto = appSettings.cryptoPhpRate > 0 ? appSettings.targetMonthlyIncomePhp / appSettings.cryptoPhpRate : 0;
            const targetBalance = appSettings.startingBalance + monthlyTargetCrypto;

            let daysRemainingLinear = Infinity;
            let requiredAvgTradeSize = 0; // LOGIC CHANGE
            let daysToVolumeTarget = Infinity;

            if (filteredTrades.length > 0) {
                const firstTradeDate = new Date(filteredTrades[0].time);
                const daysPassed = Math.max(1, (new Date() - firstTradeDate) / (1000 * 60 * 60 * 24));
                const avgDailyPnl = totalPnL / daysPassed;
                const pnlNeededForTarget = targetBalance - balanceData.calculatedBalance;

                if (avgDailyPnl > 0 && pnlNeededForTarget > 0) {
                    daysRemainingLinear = pnlNeededForTarget / avgDailyPnl;
                }

                const avgRoi = filteredTrades.reduce((sum, t) => sum + (t.roi || 0), 0) / filteredTrades.length;
                const today = new Date();
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                const daysLeftInMonth = Math.max(1, (endOfMonth.getDate() - today.getDate()));
                
                const pnlNeededThisMonth = monthlyTargetCrypto - totalPnL;
                
                if (pnlNeededThisMonth > 0 && avgRoi > 0 && appSettings.tradesPerDay > 0 && daysLeftInMonth > 0) {
                    const requiredPnlPerDay = pnlNeededThisMonth / daysLeftInMonth;
                    const requiredPnlPerTrade = requiredPnlPerDay / appSettings.tradesPerDay;
                    requiredAvgTradeSize = (requiredPnlPerTrade * 100) / avgRoi;
                }
                
                const totalVolume = filteredTrades.reduce((sum, t) => sum + (t.effectiveVolume || 0), 0);
                const avgDailyVolume = totalVolume / daysPassed;
                const volumeNeeded = appSettings.targetTradingVolume - totalVolume;
                if(avgDailyVolume > 0 && volumeNeeded > 0) {
                    daysToVolumeTarget = volumeNeeded / avgDailyVolume;
                }
            }

            const projectionResult = calculateProjections(targetBalance, filteredTrades);
            const daysRemainingProjection = projectionResult.daysToTarget;

            // --- Update UI elements ---
            document.getElementById('previousBalanceCombined').textContent = formatCombinedCurrency(balanceData.previousBalance, appSettings.cryptoPhpRate);
            document.getElementById('calculatedBalanceCombined').textContent = formatCombinedCurrency(balanceData.calculatedBalance, appSettings.cryptoPhpRate);
            document.getElementById('discrepancyCombined').textContent = formatCombinedCurrency(discrepancy, appSettings.cryptoPhpRate);
            document.getElementById('discrepancyCombined').className = discrepancy >= 0 ? 'positive' : 'negative';

            document.getElementById('currentGain').textContent = formatCurrency(lastTradeStats.currentGain);
            document.getElementById('currentGainPhp').textContent = formatPhp(lastTradeStats.currentGain * appSettings.cryptoPhpRate);
            document.getElementById('currentRoi').textContent = formatDecimalPercentage(lastTradeStats.currentRoi);

            document.getElementById('gainDifference').textContent = formatCurrency(gainDifference);
            document.getElementById('gainDifference').className = gainDifference >= 0 ? 'positive' : 'negative';
            document.getElementById('tradeAmountGrowth').textContent = formatCurrency(tradeAmountGrowth);
            document.getElementById('tradeAmountGrowth').className = tradeAmountGrowth >= 0 ? 'positive' : 'negative';

            const streaks = calculateStreaks(filteredTrades);
            let wins = filteredTrades.filter(t => t.pnl >= 0).length;
            let losses = filteredTrades.length - wins;
            document.getElementById('totalWins').textContent = wins;
            document.getElementById('totalLosses').textContent = losses;
            document.getElementById('winRate').textContent = formatPercentage(filteredTrades.length > 0 ? (wins / filteredTrades.length) * 100 : 0);
            document.getElementById('currentWinStreak').textContent = streaks.currentWinStreak;
            document.getElementById('longestWinStreak').textContent = streaks.longestWinStreak;
            document.getElementById('currentLossStreak').textContent = streaks.currentLossStreak;
            document.getElementById('longestLossStreak').textContent = streaks.longestLossStreak;

            document.getElementById('goalTargetBalance').textContent = formatCombinedCurrency(targetBalance, appSettings.cryptoPhpRate);
            document.getElementById('goalTotalGains').textContent = formatCombinedCurrency(totalPnL, appSettings.cryptoPhpRate);
            document.getElementById('goalDaysRemainingLinear').textContent = formatDays(daysRemainingLinear);
            document.getElementById('goalDaysRemainingProjection').textContent = formatDays(daysRemainingProjection);
            document.getElementById('goalRequiredAvgTradeSize').textContent = formatCombinedCurrency(requiredAvgTradeSize, appSettings.cryptoPhpRate);
            document.getElementById('daysRemainingVolumeTarget').textContent = formatDays(daysToVolumeTarget);

            updateCharts(filteredTrades);
            displayTrades(filteredTrades);
            saveState();
        }

        const noDataPlugin = {
            id: 'noData',
            afterDraw: (chart) => {
                if (chart.data.datasets.every(ds => ds.data.length === 0)) {
                    const { ctx, chartArea } = chart;
                    ctx.save();
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.font = "16px 'Helvetica Neue', Helvetica, Arial, sans-serif";
                    const textColor = getComputedStyle(document.body).getPropertyValue('--bs-secondary-color') || '#6c757d';
                    ctx.fillStyle = textColor;
                    ctx.fillText('No data to display', chartArea.left + chartArea.width / 2, chartArea.top + chartArea.height / 2);
                    ctx.restore();
                }
            }
        };

        function initializeCharts() {
            Chart.register(noDataPlugin);
            // Charts are now initialized on-demand, so this function is simpler.
        }

        function renderChart(chartInstance, canvasId, config) {
            if (chartInstance) {
                chartInstance.destroy();
            }
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, config);
        }

        // --- NEW: Consolidated Chart Update Logic ---
        function updateCharts(filteredTrades) {
            // This function now delegates to the specific chart renderers based on active view
            renderHubChart(filteredTrades);
            renderPeriodicChart(filteredTrades);
            renderMetricsChart(filteredTrades);
        }

        function renderHubChart(filteredTrades) {
            const chartType = activeChartViews.hub;
            let config;

            switch (chartType) {
                case 'cumulative':
                    let runningBalance = appSettings.startingBalance;
                    const cumulativeData = filteredTrades.map(trade => {
                        runningBalance += (trade.pnl || 0);
                        return { time: trade.time, balance: runningBalance };
                    });
                    config = {
                        type: 'line',
                        data: {
                            labels: cumulativeData.map(e => new Date(e.time).toLocaleString()),
                            datasets: [{ label: 'Cumulative Balance', data: cumulativeData.map(e => e.balance), tension: 0.1, fill: true, backgroundColor: 'rgba(75, 192, 192, 0.2)', borderColor: 'rgb(75, 192, 192)' }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { callback: value => formatCurrency(value) } }, x: { title: { display: true, text: 'Time' } } } }
                    };
                    break;
                
                case 'projection':
                     let runningBal = appSettings.startingBalance;
                     const actualData = filteredTrades.map(trade => {
                        runningBal += (trade.pnl || 0);
                        return { time: trade.time, balance: runningBal };
                    });
                     const actualLabels = actualData.map(e => e.time.split('T')[0]);
                     const projectedLabels = projectedGrowthHistory.map(e => e.time.split('T')[0]);
                     const combinedLabels = [...new Set([...actualLabels, ...projectedLabels])].sort();
                    config = {
                        type: 'line',
                        data: {
                            labels: combinedLabels,
                            datasets: [
                                { label: 'Projected Balance', data: combinedLabels.map(date => projectedGrowthHistory.find(e => e.time.startsWith(date))?.balance ?? null), borderColor: 'rgb(0, 123, 255)', borderDash: [5, 5], tension: 0.1, pointRadius: 0 },
                                { label: 'Actual Balance', data: combinedLabels.map(date => actualData.slice().reverse().find(e => e.time.startsWith(date))?.balance ?? null), borderColor: 'rgb(40, 167, 69)', tension: 0.1, pointRadius: 3, fill: true, backgroundColor: 'rgba(40, 167, 69, 0.1)' }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { callback: value => formatCurrency(value) } }, x: { title: { display: true, text: 'Date' } } } }
                    };
                    break;

                case 'discrepancy':
                    config = {
                        type: 'line',
                        data: {
                            labels: discrepancyHistory.map(e => new Date(e.time).toLocaleTimeString()),
                            datasets: [{ label: 'Balance Discrepancy', data: discrepancyHistory.map(e => e.value), borderColor: 'rgb(255, 99, 132)', tension: 0.1 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { callback: value => formatCurrency(value) } }, x: { title: { display: true, text: 'Time of Update' } } } }
                    };
                    break;
            }
            hubChart = renderChart(hubChart, 'hubChartCanvas', config);
        }

        function renderPeriodicChart(filteredTrades) {
            const chartType = activeChartViews.periodic;
            let config;
            const dailyData = {};
            filteredTrades.forEach(trade => {
                const tradeDate = new Date(trade.time);
                if (isNaN(tradeDate.getTime())) return;
                const fullDate = `${tradeDate.getFullYear()}-${(tradeDate.getMonth() + 1).toString().padStart(2, '0')}-${tradeDate.getDate().toString().padStart(2, '0')}`;
                dailyData[fullDate] = dailyData[fullDate] || { pnl: 0, volume: 0, roiSum: 0, roiCount: 0 };
                dailyData[fullDate].pnl += (trade.pnl || 0);
                dailyData[fullDate].roiSum += (trade.roi || 0);
                dailyData[fullDate].roiCount++;
            });
            const sortedDates = Object.keys(dailyData).sort();

            switch (chartType) {
                case 'monthlyPnl':
                    const monthlyData = {};
                    filteredTrades.forEach(trade => {
                        const tradeDate = new Date(trade.time);
                        if (isNaN(tradeDate.getTime())) return;
                        const yearMonth = `${tradeDate.getFullYear()}-${(tradeDate.getMonth() + 1).toString().padStart(2, '0')}`;
                        monthlyData[yearMonth] = monthlyData[yearMonth] || { pnl: 0 };
                        monthlyData[yearMonth].pnl += (trade.pnl || 0);
                    });
                    const sortedMonths = Object.keys(monthlyData).sort();
                    config = {
                        type: 'line',
                        data: {
                            labels: sortedMonths,
                            datasets: [{ label: 'Monthly PNL', data: sortedMonths.map(m => monthlyData[m].pnl), tension: 0.1, fill: false, borderColor: 'rgb(75, 192, 192)' }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => formatCurrency(value) } }, x: { title: { display: true, text: 'Month' } } } }
                    };
                    break;
                case 'dailyPnl':
                     const dayMap = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                     const dayColors = { 'Sun': 'rgba(255, 99, 132, 0.7)', 'Mon': 'rgba(54, 162, 235, 0.7)', 'Tue': 'rgba(255, 206, 86, 0.7)', 'Wed': 'rgba(75, 192, 192, 0.7)', 'Thu': 'rgba(153, 102, 255, 0.7)', 'Fri': 'rgba(255, 159, 64, 0.7)', 'Sat': 'rgba(99, 255, 132, 0.7)' };
                    config = {
                        type: 'bar',
                        data: {
                            labels: sortedDates,
                            datasets: [{ label: 'Daily PNL', data: sortedDates.map(d => dailyData[d].pnl), backgroundColor: sortedDates.map(dateStr => dayColors[dayMap[new Date(dateStr).getUTCDay()]]) }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => formatCurrency(value) } }, x: { title: { display: true, text: 'Date' } } } }
                    };
                    break;
                case 'dailyRoi':
                    config = {
                        type: 'line',
                        data: {
                            labels: sortedDates,
                            datasets: [{ label: 'Daily ROI (%)', data: sortedDates.map(d => dailyData[d].roiCount > 0 ? dailyData[d].roiSum / dailyData[d].roiCount : 0), borderColor: 'rgb(255, 159, 64)', tension: 0.1 }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => value.toFixed(2) + ' %' } }, x: { title: { display: true, text: 'Date' } } } }
                    };
                    break;
            }
            periodicChart = renderChart(periodicChart, 'periodicChartCanvas', config);
        }

        function renderMetricsChart(filteredTrades) {
            const chartType = activeChartViews.metrics;
            let config;

            switch (chartType) {
                case 'byAsset':
                    const pnlByAsset = {};
                    filteredTrades.forEach(trade => {
                        if (!pnlByAsset[trade.pair]) pnlByAsset[trade.pair] = { pnl: 0, wins: 0, losses: 0 };
                        pnlByAsset[trade.pair].pnl += (trade.pnl || 0);
                        if ((trade.pnl || 0) >= 0) pnlByAsset[trade.pair].wins++;
                        else pnlByAsset[trade.pair].losses++;
                    });
                    const sortedAssets = Object.keys(pnlByAsset).sort((a, b) => pnlByAsset[b].pnl - pnlByAsset[a].pnl);
                    config = {
                        type: 'bar',
                        data: {
                            labels: sortedAssets,
                            datasets: [
                                { label: 'Total PNL', data: sortedAssets.map(asset => pnlByAsset[asset].pnl), backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                                { label: 'Win Rate (%)', data: sortedAssets.map(asset => { const stats = pnlByAsset[asset]; return (stats.wins + stats.losses > 0) ? (stats.wins / (stats.wins + stats.losses)) * 100 : 0; }), type: 'line', yAxisID: 'y1', borderColor: 'rgb(255, 159, 64)', tension: 0.1 }
                            ]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => formatCurrency(value) } }, x: { title: { display: true, text: 'Asset' } }, y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: value => value.toFixed(1) + '%' } } } }
                    };
                    break;
                case 'avgWinLoss':
                    let totalWinsPnl = 0, winCount = 0, totalLossesPnl = 0, lossCount = 0;
                     filteredTrades.forEach(trade => {
                        if ((trade.pnl || 0) >= 0) { totalWinsPnl += trade.pnl; winCount++; }
                        else { totalLossesPnl += trade.pnl; lossCount++; }
                    });
                    const avgWin = winCount > 0 ? totalWinsPnl / winCount : 0;
                    const avgLoss = lossCount > 0 ? totalLossesPnl / lossCount : 0;
                    config = {
                        type: 'bar',
                        data: {
                            labels: ['Average Win', 'Average Loss'],
                            datasets: [{ label: 'Average Amount', data: [avgWin, avgLoss], backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'] }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => formatCurrency(value) } }, x: { title: { display: true, text: 'Outcome' } } } }
                    };
                    break;
                case 'monthlyVolume':
                    const monthlyVolData = {};
                    filteredTrades.forEach(trade => {
                        const tradeDate = new Date(trade.time);
                        if (isNaN(tradeDate.getTime())) return;
                        const yearMonth = `${tradeDate.getFullYear()}-${(tradeDate.getMonth() + 1).toString().padStart(2, '0')}`;
                        monthlyVolData[yearMonth] = monthlyVolData[yearMonth] || { volume: 0 };
                        monthlyVolData[yearMonth].volume += (trade.effectiveVolume || 0);
                    });
                    const sortedVolMonths = Object.keys(monthlyVolData).sort();
                    config = {
                        type: 'bar',
                        data: {
                            labels: sortedVolMonths,
                            datasets: [{ label: 'Monthly Trade Volume', data: sortedVolMonths.map(m => monthlyVolData[m].volume), backgroundColor: 'rgba(54, 162, 235, 0.6)' }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { callback: value => formatCurrency(value) } }, x: { title: { display: true, text: 'Month' } } } }
                    };
                    break;
            }
            metricsChart = renderChart(metricsChart, 'metricsChartCanvas', config);
        }

        // --- Data Parsing & Handling ---
        function displayTrades(filteredTrades) {
            const tradeHistoryOutput = document.getElementById('tradeHistoryOutput');
            tradeHistoryOutput.innerHTML = '';
            if (filteredTrades.length === 0) {
                tradeHistoryOutput.innerHTML = '<p class="text-center text-muted m-0">No trades for the selected currency.</p>';
                return;
            }
            [...filteredTrades].sort((a, b) => new Date(b.time) - new Date(a.time)).forEach(trade => {
                const tradeDiv = document.createElement('div');
                tradeDiv.classList.add('trade-entry');
                tradeDiv.innerHTML = `
                    <div class="d-flex justify-content-between"><span>Pair:</span> <strong>${trade.pair || 'N/A'}</strong></div>
                    <div class="d-flex justify-content-between"><span>Time:</span> <small>${trade.time || 'N/A'}</small></div>
                    <div class="d-flex justify-content-between"><span>PNL:</span> <strong class="${(trade.pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(trade.pnl || 0, trade.currency)}</strong></div>
                    <div class="d-flex justify-content-between"><span>ROI:</span> <strong class="${(trade.pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatDecimalPercentage(trade.roi || 0)}</strong></div>
                `;
                tradeHistoryOutput.appendChild(tradeDiv);
            });
        }

        function parseTradeData(rawData) {
            const currency = appSettings.selectedCrypto;
            const patterns = {
                pair: /^([A-Z0-9]{2,10}\/[A-Z0-9]{2,10})$/i,
                orderNo: /^Order No\.\s*(\d+)$/i,
                time: /^Time\s*(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})$/i,
                pnl: new RegExp(`^PNL\\s*([+-]?[\\d.]+)\\s*${currency}`, 'i'),
                roi: /^ROI\s*≈?\s*([\d.]+)\s*%$/i,
                effectiveVolume: new RegExp(`^Effective trading volume\\s*([\\d.]+)\\s*${currency}`, 'i')
            };
            const tradeBlocks = rawData.replace(/\r\n/g, '\n').split(/\n{2,}/);
            const parsedTrades = [];

            tradeBlocks.forEach(block => {
                const trade = { currency: currency };
                const lines = block.split('\n').map(cleanLine).filter(Boolean);
                lines.forEach(line => {
                    for (const key in patterns) {
                        const match = line.match(patterns[key]);
                        if (match) {
                            trade[key] = key.match(/pnl|roi|effectiveVolume/) ? parseFloat(match[1]) : match[1];
                            return;
                        }
                    }
                });
                if (trade.pair && trade.time && trade.orderNo && !isNaN(trade.pnl)) {
                    parsedTrades.push(trade);
                }
            });
            return parsedTrades;
        }

        function handleNewParsedTrades(newTrades) {
            const messageEl = document.getElementById('dataInputMessage');
            const existingOrderNos = new Set(tradeHistory.map(t => t.orderNo));
            const uniqueNewTrades = newTrades.filter(t => !existingOrderNos.has(t.orderNo));

            if (uniqueNewTrades.length > 0) {
                const lastNewTrade = uniqueNewTrades[uniqueNewTrades.length - 1];
                if(lastNewTrade.pnl > 0) playSound('win');
                if(lastNewTrade.pnl < 0) playSound('loss');

                balanceData.previousBalance = balanceData.calculatedBalance;

                tradeHistory.push(...uniqueNewTrades);
                tradeHistory.sort((a, b) => new Date(a.time) - new Date(b.time));
                
                document.getElementById('tradeDataInput').value = '';
                messageEl.textContent = `${uniqueNewTrades.length} new trade(s) added successfully.`;
                messageEl.className = 'form-text text-success';
                updateAllMetrics();
            } else {
                messageEl.textContent = "No new trades found. Data may be a duplicate or formatted for the wrong currency.";
                messageEl.className = 'form-text text-danger';
            }
        }

        // --- Guided Tour ---
        function setupTour() {
            tour = new Shepherd.Tour({
                useModalOverlay: true,
                defaultStepOptions: {
                    classes: 'shadow-md',
                    scrollTo: true
                }
            });

            tour.addStep({
                title: 'Welcome!',
                text: 'This is a quick tour of your dashboard. Let\'s get you set up.',
                buttons: [{ text: 'Next', action: tour.next }],
                classes: 'shepherd-step-welcome' // Special class for the first step
            });

            tour.addStep({ title: 'Step 1: Financial Settings', text: 'First, select your trading currency, enter your starting balance, target income, and the current Crypto/PHP rate here.', attachTo: { element: '#financialGoalsCard', on: window.innerWidth < 768 ? 'bottom' : 'top' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Step 2: Add Your Trades', text: 'Now, paste your trade history into this box. Make sure the currency matches what you selected in settings.', attachTo: { element: '#dataInputCard', on: window.innerWidth < 768 ? 'bottom' : 'right' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Step 3: Update Your Balance', text: 'Finally, enter your actual current wallet balance here. The dashboard will calculate any discrepancy for you.', attachTo: { element: '#balanceOverviewCard', on: 'bottom' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Done', action: tour.complete }] });
            tour.on('complete', () => localStorage.setItem('hasSeenTour', 'true'));
        }

        // --- Data I/O ---
        function showResetModal() {
            if (!resetModal) {
                resetModal = new bootstrap.Modal(document.getElementById('resetConfirmationModal'));
            }
            resetModal.show();
        }

        function performReset() {
            localStorage.clear(); 
            window.location.reload();
        }

        function exportData() {
            const messageEl = document.getElementById('dataInputMessage');
            const allData = JSON.parse(localStorage.getItem('tradeTrackerData'));
            if (!allData || !allData.tradeHistory || allData.tradeHistory.length === 0) {
                messageEl.textContent = "No data available to export.";
                messageEl.className = 'form-text text-warning';
                return;
            }
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trade_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            messageEl.textContent = "Data exported successfully.";
            messageEl.className = 'form-text text-success';
        }

        function importData() {
            const input = document.createElement('input');
            const messageEl = document.getElementById('dataInputMessage');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData && typeof importedData === 'object' && importedData.appSettings && importedData.tradeHistory) {
                            loadState(importedData);
                            populateCurrencySelector().then(() => {
                                updateUiFromState();
                                updateAllMetrics();
                            });
                            messageEl.textContent = "Data imported successfully!";
                            messageEl.className = 'form-text text-success';
                        } else {
                            throw new Error("Invalid or corrupted data file.");
                        }
                    } catch (error) {
                        messageEl.textContent = "Failed to import data: " + error.message;
                        messageEl.className = 'form-text text-danger';
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // --- API Functions ---
        async function populateCurrencySelector() {
            const select = document.getElementById('selectedCryptoSelect');
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=150&page=1');
                if (!response.ok) throw new Error('Failed to fetch coin list');
                coinList = await response.json();
                
                select.innerHTML = '';
                coinList.forEach(coin => {
                    const option = document.createElement('option');
                    option.value = coin.symbol.toUpperCase();
                    option.textContent = coin.name;
                    option.dataset.id = coin.id;
                    select.appendChild(option);
                });
                select.value = appSettings.selectedCrypto;
            } catch (error) {
                console.error("Could not populate currency selector:", error);
                select.innerHTML = '<option value="USDT">USDT</option><option value="BTC">BTC</option><option value="ETH">ETH</option>';
            }
        }

        async function fetchExchangeRate() {
            const select = document.getElementById('selectedCryptoSelect');
            if (select.options.length <= 1 && select.options[0].textContent.includes('Loading')) {
                await new Promise(resolve => setTimeout(resolve, 500)); 
            }
            const selectedOption = select.selectedOptions[0];
            if (!selectedOption) return;
            const coinId = selectedOption.dataset.id || appSettings.selectedCrypto.toLowerCase();
            
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=php`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const rate = data[coinId]?.php;
                if (rate) {
                    appSettings.cryptoPhpRate = rate;
                    document.getElementById('cryptoPhpRate').value = rate;
                } else {
                     document.getElementById('cryptoPhpRate').value = 0;
                }
            } catch (error) {
                console.error("Could not fetch live exchange rate, using saved value.", error);
            }
        }

        // --- Main DOMContentLoaded Event Listener ---
        document.addEventListener('DOMContentLoaded', async () => {
            initializeCharts();
            setupTour();
            loadState();
            await populateCurrencySelector();
            updateUiFromState();
            await fetchExchangeRate();
            await updateAllMetrics();

            // --- Event Listeners ---
            document.querySelectorAll('input[type="number"], select').forEach(el => el.addEventListener('change', updateAllMetrics));
            
            document.getElementById('schedulePlannerInput').addEventListener('input', (e) => { appSettings.schedulePlanner = e.target.value; saveState(); });
            
            document.getElementById('processDataButton').addEventListener('click', () => handleNewParsedTrades(parseTradeData(document.getElementById('tradeDataInput').value)));
            document.getElementById('clearDataInputButton').addEventListener('click', () => {
                document.getElementById('tradeDataInput').value = '';
                document.getElementById('dataInputMessage').textContent = '';
            });
            document.getElementById('themeToggle').addEventListener('click', () => { appSettings.theme = appSettings.theme === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-bs-theme', appSettings.theme); saveState(); });
            
            // Reset button listeners
            document.getElementById('resetDataButtonBottom').addEventListener('click', showResetModal);
            document.getElementById('confirmResetButton').addEventListener('click', performReset);

            document.getElementById('exportDataButton').addEventListener('click', exportData);
            document.getElementById('importDataButton').addEventListener('click', importData);
            document.getElementById('startTourButton').addEventListener('click', () => tour.start());
            document.getElementById('projectionMethodSelect').addEventListener('change', (e) => {
                appSettings.selectedProjectionMethod = e.target.value;
                toggleProjectionInputs(e.target.value);
                updateAllMetrics();
            });

            // NEW: Chart toggle button listener
            document.querySelectorAll('.chart-toggle-buttons .btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { chartCard, chartType } = e.target.dataset;
                    
                    // Update active state in memory
                    activeChartViews[chartCard] = chartType;

                    // Update button visual state
                    document.querySelectorAll(`.chart-toggle-buttons .btn[data-chart-card="${chartCard}"]`).forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');

                    // Re-render the specific chart and save state
                    updateAllMetrics();
                });
            });

            document.querySelectorAll('.collapse').forEach(el => {
                el.addEventListener('show.bs.collapse', e => { const card = e.target.closest('.card'); if(card) { cardStates[card.id] = 'expanded'; saveState(); } });
                el.addEventListener('hide.bs.collapse', e => { const card = e.target.closest('.card'); if(card) { cardStates[card.id] = 'collapsed'; saveState(); } });
            });

            if (!localStorage.getItem('hasSeenTour') && tradeHistory.length === 0) {
                tour.start();
            }

            new Sortable(document.getElementById('card-container'), { animation: 150, handle: '.card-header' });
        });
    </script>
</body>
</html>
