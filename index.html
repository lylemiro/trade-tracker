<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Progress Tracker</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- Shepherd.js for Guided Tour -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>

    <style>
        /* Custom styles to complement Bootstrap */
        :root {
            --bs-body-font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --positive-color: #198754;
            --negative-color: #dc3545;
        }

        [data-bs-theme="dark"] {
            --positive-color: #20c997;
            --negative-color: #fd7e14;
        }

        .positive { color: var(--positive-color) !important; }
        .negative { color: var(--negative-color) !important; }

        .card-header {
            cursor: grab;
        }
        .card-header:active {
            cursor: grabbing;
        }
        
        /* Collapse icon transition */
        .collapse-icon {
            transition: transform 0.3s ease;
        }
        [aria-expanded="false"] .collapse-icon {
            transform: rotate(-90deg);
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        #tradeHistoryOutput {
            max-height: 400px;
            overflow-y: auto;
        }
        .trade-entry:not(:last-child) {
            border-bottom: 1px dashed var(--bs-border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        /* Shepherd.js tour styling */
        .shepherd-element {
            max-width: 175px; /* User requested width */
        }
        .shepherd-has-title .shepherd-content .shepherd-header {
            background: #e6e6e6;
            padding: 9px;
        }
        .shepherd-footer {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
            display: flex;
            justify-content: flex-end;
            padding: 0 9px 9px;
        }
        .shepherd-title {
            font-size: 11px !important;
            font-weight: bold !important;
        }
        .shepherd-text {
            font-size: 10px !important; /* User requested font size */
        }
        .shepherd-button {
            background: var(--bs-primary);
            color: white;
            border: none;
            padding: 0.25rem 0.5rem; /* Smaller padding */
            font-size: 10px;          /* Smaller font size */
            border-radius: 0.25rem;
            margin-right: 0.5rem;
        }
        .shepherd-button:hover {
            opacity: 0.9;
        }
        .shepherd-button.shepherd-button-secondary {
            background: var(--bs-secondary);
        }
        
        /* Card title padding adjustment */
        .card h2, .card h3 {
            padding-bottom: 8px; /* Reduced from 10px */
        }
    </style>
</head>
<body>
    <!-- --- HTML STRUCTURE (Bootstrap) --- -->
    <div class="container-fluid p-3 p-lg-4">
        <header class="p-3 mb-4 rounded-3 text-bg-primary shadow-sm">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">Trade Progress Dashboard</h1>
                <div>
                    <button class="btn btn-light rounded-pill me-2" id="startTourButton">
                        <i class="bi bi-question-circle-fill"></i> Help
                    </button>
                    <button class="btn btn-outline-light rounded-pill" id="themeToggle">
                        <i class="bi bi-moon-stars-fill"></i> Toggle Theme
                    </button>
                </div>
            </div>
        </header>

        <div class="row g-4" id="card-container">
            <!-- Row 1: High-Level Summaries -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="calculatedGoalsCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseCalculatedGoals" role="button" aria-expanded="true" aria-controls="collapseCalculatedGoals">
                        <h2 class="h5 mb-0"><i class="bi bi-bullseye me-2"></i>Calculated Goals</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseCalculatedGoals">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2"><span>Target Balance:</span> <strong id="goalTargetBalance"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Total Gains:</span> <strong id="goalTotalGains" class="positive"></strong></div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2" title="Based on your average daily profit since your first trade.">
                                <span>Days to Target (Linear):</span> <strong id="goalDaysRemainingLinear"></strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2" title="Based on your selected projection method and trades per day.">
                                <span>Days to Target (Projection):</span> <strong id="goalDaysRemainingProjection"></strong>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between" title="The wallet size needed to hit your monthly target in the remaining days of this month, based on your historical average ROI and trades per day.">
                                <span>Wallet Balance Needed:</span> <strong id="goalWalletBalanceNeeded" class="text-info"></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="gainsSummaryCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseGains" role="button" aria-expanded="true" aria-controls="collapseGains">
                        <h2 class="h5 mb-0"><i class="bi bi-graph-up-arrow me-2"></i>Gains Summary</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseGains">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2"><span>Current Gain (USDT):</span> <strong id="currentGainUsdt"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Current Gain (₱):</span> <strong id="currentGainPhp"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Current ROI:</span> <strong id="currentRoi"></strong></div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2"><span>Gain Difference (USDT):</span> <strong id="gainDifferenceUsdt"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Trade Amount Growth:</span> <strong id="tradeAmountGrowth"></strong></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="balanceOverviewCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseBalance" role="button" aria-expanded="true" aria-controls="collapseBalance">
                        <h2 class="h5 mb-0"><i class="bi bi-wallet2 me-2"></i>Balance Overview</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseBalance">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2"><span>Previous Balance:</span> <strong id="previousBalanceCombined"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Calculated Balance:</span> <strong id="calculatedBalanceCombined"></strong></div>
                            <hr>
                            <div class="mb-2">
                                <label for="actualCurrentBalanceUsdtInput" class="form-label">Actual Current Balance (USDT)</label>
                                <input type="number" id="actualCurrentBalanceUsdtInput" value="0" step="0.01" class="form-control">
                            </div>
                            <div class="d-flex justify-content-between"><strong>Discrepancy:</strong> <strong id="discrepancyCombined"></strong></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Daily & Streak Analytics -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="streakAnalyticsCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseStreaks" role="button" aria-expanded="true" aria-controls="collapseStreaks">
                        <h2 class="h5 mb-0"><i class="bi bi-trophy me-2"></i>Streak Analytics</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseStreaks">
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2"><span>Current Win Streak:</span> <strong id="currentWinStreak" class="positive"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Longest Win Streak:</span> <strong id="longestWinStreak" class="positive"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Current Loss Streak:</span> <strong id="currentLossStreak" class="negative"></strong></div>
                            <div class="d-flex justify-content-between mb-2"><span>Longest Loss Streak:</span> <strong id="longestLossStreak" class="negative"></strong></div>
                            <hr>
                            <div class="d-flex justify-content-between mb-2"><span>Total Wins / Losses:</span> <strong><span id="totalWins" class="positive"></span> / <span id="totalLosses" class="negative"></span></strong></div>
                            <div class="d-flex justify-content-between"><span>Win Rate:</span> <strong id="winRate"></strong></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="dailyRoiChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseDailyRoi" role="button" aria-expanded="true" aria-controls="collapseDailyRoi"><h2 class="h5 mb-0">Daily ROI</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapseDailyRoi"><div class="card-body"><div class="chart-container"><canvas id="dailyRoiChart"></canvas></div></div></div></div></div>
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="dailyVolumeChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseDailyVol" role="button" aria-expanded="true" aria-controls="collapseDailyVol"><h2 class="h5 mb-0">Daily Volume</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapseDailyVol"><div class="card-body"><div class="chart-container"><canvas id="dailyVolumeChart"></canvas></div></div></div></div></div>

            <!-- Row 3: Performance Breakdowns -->
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="pnlByDayChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapsePnlDay" role="button" aria-expanded="true" aria-controls="collapsePnlDay"><h2 class="h5 mb-0">PNL by Day</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapsePnlDay"><div class="card-body"><div class="chart-container"><canvas id="pnlByDayChart"></canvas></div></div></div></div></div>
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="pnlByAssetChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapsePnlAsset" role="button" aria-expanded="true" aria-controls="collapsePnlAsset"><h2 class="h5 mb-0">Performance by Asset</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapsePnlAsset"><div class="card-body"><div class="chart-container"><canvas id="pnlByAssetChart"></canvas></div></div></div></div></div>
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="avgWinLossChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseAvgWinLoss" role="button" aria-expanded="true" aria-controls="collapseAvgWinLoss"><h2 class="h5 mb-0">Avg Win vs. Loss</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapseAvgWinLoss"><div class="card-body"><div class="chart-container"><canvas id="avgWinLossChart"></canvas></div></div></div></div></div>

            <!-- Row 4: Monthly & Cumulative Charts -->
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="monthlyPnlChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseMonthlyPnl" role="button" aria-expanded="true" aria-controls="collapseMonthlyPnl"><h2 class="h5 mb-0">Monthly PNL</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapseMonthlyPnl"><div class="card-body"><div class="chart-container"><canvas id="monthlyPnLChart"></canvas></div></div></div></div></div>
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="monthlyVolumeChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseMonthlyVol" role="button" aria-expanded="true" aria-controls="collapseMonthlyVol"><h2 class="h5 mb-0">Monthly Volume</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapseMonthlyVol"><div class="card-body"><div class="chart-container"><canvas id="monthlyVolumeChart"></canvas></div></div></div></div></div>
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="cumulativeBalanceChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseCumBalance" role="button" aria-expanded="true" aria-controls="collapseCumBalance"><h2 class="h5 mb-0">Cumulative Balance</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapseCumBalance"><div class="card-body"><div class="chart-container"><canvas id="cumulativeBalanceChart"></canvas></div></div></div></div></div>

            <!-- Row 5: Projections & Long-Term -->
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="projectedGrowthChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseProjGrowth" role="button" aria-expanded="true" aria-controls="collapseProjGrowth"><h2 class="h5 mb-0">Projected Growth</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapseProjGrowth"><div class="card-body"><div class="chart-container"><canvas id="projectedGrowthChart"></canvas></div></div></div></div></div>
            <div class="col-12 col-lg-6 col-xl-4"><div class="card shadow-sm" id="discrepancyChartCard"><div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseDiscrepancy" role="button" aria-expanded="true" aria-controls="collapseDiscrepancy"><h2 class="h5 mb-0">Discrepancy History</h2><i class="bi bi-chevron-down collapse-icon"></i></div><div class="collapse show" id="collapseDiscrepancy"><div class="card-body"><div class="chart-container"><canvas id="discrepancyChart"></canvas></div></div></div></div></div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="schedulePlannerCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseSchedule" role="button" aria-expanded="true" aria-controls="collapseSchedule">
                        <h2 class="h5 mb-0"><i class="bi bi-calendar-week me-2"></i>Trading Schedule</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseSchedule">
                        <div class="card-body">
                            <textarea id="schedulePlannerInput" class="form-control" rows="5" placeholder="e.g., Monday: 9 AM - 12 PM, Focus on BTC/USDT..."></textarea>
                            <small class="form-text text-muted">Your schedule will auto-save.</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 6: Settings -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="financialGoalsCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseGoals" role="button" aria-expanded="true" aria-controls="collapseGoals">
                        <h2 class="h5 mb-0"><i class="bi bi-gear me-2"></i>Goals & Settings</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseGoals">
                        <div class="card-body">
                            <h6 class="text-muted">Core Inputs</h6>
                            <div class="mb-2"><label>USDT/PHP Rate:</label><input type="number" id="usdtPhpRate" class="form-control form-control-sm"></div>
                            <div class="mb-2"><label>Target Monthly Income (₱):</label><input type="number" id="targetMonthlyIncomePhp" class="form-control form-control-sm"></div>
                            <div class="mb-3"><label>Starting Balance (USDT):</label><input type="number" id="startingBalanceUsdt" class="form-control form-control-sm"></div>
                            <hr>
                            <h6 class="text-muted">Volume Target</h6>
                            <div class="mb-2"><label>Target Trading Volume (USDT):</label><input type="number" id="targetTradingVolumeInput" class="form-control form-control-sm"></div>
                            <div class="d-flex justify-content-between"><span>Days Remaining (Volume):</span> <strong id="daysRemainingVolumeTarget"></strong></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="projectionSettingsCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseProjections" role="button" aria-expanded="true" aria-controls="collapseProjections">
                        <h2 class="h5 mb-0"><i class="bi bi-binoculars me-2"></i>Projection Settings</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseProjections">
                        <div class="card-body">
                            <div class="mb-2"><label>Method:</label><select id="projectionMethodSelect" class="form-select form-select-sm"><option value="percent">By % Gain Per Trade</option><option value="fixedRoi">By Fixed Trade Amt & ROI</option></select></div>
                            <div class="mb-2"><label>Trades Per Day:</label><input type="number" id="tradesPerDayInput" class="form-control form-control-sm"></div>
                            <div class="mb-3"><label>Projection Period (Days):</label><input type="number" id="projectionPeriodDaysInput" class="form-control form-control-sm"></div>
                            <div id="percentProjectionInputs"><hr><h6 class="text-muted">% Gain Details</h6><div class="mb-2"><label>Projected Gain Per Trade (%):</label><input type="number" id="projectedGainPerTradeInput" class="form-control form-control-sm"></div></div>
                            <div id="fixedRoiProjectionInputs"><hr><h6 class="text-muted">Fixed Amount Details</h6><div class="mb-2"><label>Projected Trade Amount (USDT):</label><input type="number" id="projectedTradeAmountInput" class="form-control form-control-sm"></div><div class="mb-2"><label>Projected ROI Per Trade (%):</label><input type="number" id="projectedRoiPerTradeInput" class="form-control form-control-sm"></div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row 7: Input & History (Lowest Priority) -->
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="dataInputCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseDataInput" role="button" aria-expanded="true" aria-controls="collapseDataInput">
                        <h2 class="h5 mb-0"><i class="bi bi-file-earmark-plus me-2"></i>Input & Data</h2>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseDataInput">
                        <div class="card-body">
                            <textarea id="tradeDataInput" class="form-control mb-2" rows="8" placeholder="Paste your detailed trade history here..."></textarea>
                            <button id="processDataButton" class="btn btn-primary w-100">Process Trades</button>
                            <div class="d-flex gap-2 mt-2">
                                <button id="importDataButton" class="btn btn-secondary w-50">Import Data</button>
                                <button id="exportDataButton" class="btn btn-secondary w-50">Export Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6 col-xl-4">
                <div class="card shadow-sm" id="processedHistoryCard">
                    <div class="card-header d-flex justify-content-between align-items-center" data-bs-toggle="collapse" href="#collapseHistory" role="button" aria-expanded="true" aria-controls="collapseHistory">
                        <h3 class="h5 mb-0"><i class="bi bi-list-ol me-2"></i>Processed Trade History</h3>
                        <i class="bi bi-chevron-down collapse-icon"></i>
                    </div>
                    <div class="collapse show" id="collapseHistory">
                        <div class="card-body">
                            <div id="tradeHistoryOutput" class="p-2 border rounded bg-light-subtle"><p class="text-center text-muted m-0">No trade data processed yet.</p></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reset Button -->
            <div class="col-12 text-center">
                <button class="btn btn-danger" id="resetDataButtonBottom"><i class="bi bi-trash me-2"></i>Reset All Data</button>
            </div>
        </div>
    </div>

    <audio id="winSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_73138b3213.mp3" preload="auto"></audio>
    <audio id="lossSound" src="https://cdn.pixabay.com/audio/2021/08/04/audio_593713fba2.mp3" preload="auto"></audio>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <script>
        /* --- JAVASCRIPT LOGIC (script.js) --- */
        // --- GLOBAL VARIABLES (Accessible throughout the script) ---
        let monthlyPnLChart, monthlyVolumeChart, dailyRoiChart, dailyVolumeChart, discrepancyChart, cumulativeBalanceChart, projectedGrowthChart, pnlByDayChart, pnlByAssetChart, avgWinLossChart;
        let tour;

        const DEFAULT_APP_SETTINGS = { usdtPhpRate: 58.90, targetMonthlyIncomePhp: 50000, startingBalanceUsdt: 301, projectedGainPerTrade: 1, tradesPerDay: 2, projectionPeriodDays: 90, projectedTradeAmount: 3.00, projectedRoiPerTrade: 70, selectedProjectionMethod: 'percent', theme: 'light', schedulePlanner: '', targetTradingVolume: 300 };
        const DEFAULT_BALANCE_DATA = { previousBalanceUsdt: 0, calculatedBalanceUsdt: 0, actualBalanceUsdt: 0 };
        const DEFAULT_LAST_TRADE_STATS = { currentGainUsdt: 0, currentRoi: 0, previousGainUsdt: 0, lastTradeAmount: 0, previousTradeAmount: 0 };
        const DEFAULT_CARD_STATES = {};

        let tradeHistory = [], appSettings = { ...DEFAULT_APP_SETTINGS }, balanceData = { ...DEFAULT_BALANCE_DATA }, lastTradeStats = { ...DEFAULT_LAST_TRADE_STATS }, cardStates = { ...DEFAULT_CARD_STATES }, discrepancyHistory = [], cumulativeBalanceHistory = [], projectedGrowthHistory = [];

        // --- Helper Functions ---
        const cleanLine = (line) => line.replace(/[\u00A0\u200B-\u200D\uFEFF]/g, ' ').replace(/\s+/g, ' ').trim();
        const formatCurrency = (amount, currency = 'USDT') => `${amount.toFixed(2)} ${currency}`;
        const formatPhp = (amount) => `₱${amount.toFixed(2)}`;
        const formatDecimalPercentage = (value) => `${value.toFixed(2)} %`;
        const formatPercentage = (value) => `${value.toFixed(2)}%`;
        const formatCombinedCurrency = (usdt, rate) => `${usdt.toFixed(2)} USDT (₱${(usdt * rate).toFixed(2)})`;
        const formatDays = (days) => isFinite(days) && days > 0 ? `${days.toFixed(2)} days` : 'N/A';

        function playSound(type) {
            const sound = document.getElementById(type === 'win' ? 'winSound' : 'lossSound');
            if (sound) sound.play().catch(e => console.error(`Error playing ${type} sound:`, e));
        }

        function toggleProjectionInputs(method) {
            document.getElementById('percentProjectionInputs').style.display = method === 'percent' ? 'block' : 'none';
            document.getElementById('fixedRoiProjectionInputs').style.display = method === 'fixedRoi' ? 'block' : 'none';
        }

        // --- State Management ---
        function saveState() {
            localStorage.setItem('tradeTrackerData', JSON.stringify({ tradeHistory, appSettings, balanceData, lastTradeStats, cardStates, discrepancyHistory, cumulativeBalanceHistory, projectedGrowthHistory }));
        }

        function loadState(dataToLoad = null) {
            const data = dataToLoad || (JSON.parse(localStorage.getItem('tradeTrackerData')) || {});
            tradeHistory = data.tradeHistory || [];
            appSettings = { ...DEFAULT_APP_SETTINGS, ...(data.appSettings || {}) };
            balanceData = { ...DEFAULT_BALANCE_DATA, ...(data.balanceData || {}) };
            lastTradeStats = { ...DEFAULT_LAST_TRADE_STATS, ...(data.lastTradeStats || {}) };
            cardStates = data.cardStates || {};
            discrepancyHistory = data.discrepancyHistory || [];
            cumulativeBalanceHistory = data.cumulativeBalanceHistory || [];
            projectedGrowthHistory = data.projectedGrowthHistory || [];
            updateUiFromState();
        }

        function updateUiFromState() {
            Object.keys(appSettings).forEach(key => {
                const el = document.getElementById(key) || document.getElementById(key + 'Input') || document.getElementById(key + 'Select');
                if (el) {
                    if (key === 'schedulePlanner') {
                        el.value = appSettings[key];
                    } else if (el.id === 'projectionMethodSelect') {
                        el.value = appSettings.selectedProjectionMethod;
                    } else {
                        el.value = appSettings[key];
                    }
                }
            });

            document.getElementById('actualCurrentBalanceUsdtInput').value = balanceData.actualBalanceUsdt;
            document.documentElement.setAttribute('data-bs-theme', appSettings.theme);
            toggleProjectionInputs(appSettings.selectedProjectionMethod);

            for (const cardId in cardStates) {
                const card = document.getElementById(cardId);
                const collapseTarget = card?.querySelector('.collapse');
                if (card && collapseTarget) {
                    const bsCollapse = bootstrap.Collapse.getOrCreateInstance(collapseTarget);
                    if (cardStates[cardId] === 'collapsed') bsCollapse.hide();
                    else bsCollapse.show();
                }
            }
        }

        function calculateStreaks() {
            let currentWinStreak = 0, longestWinStreak = 0, currentLossStreak = 0, longestLossStreak = 0;
            tradeHistory.forEach(trade => {
                if (trade.pnl >= 0) {
                    currentWinStreak++;
                    currentLossStreak = 0;
                    if (currentWinStreak > longestWinStreak) {
                        longestWinStreak = currentWinStreak;
                    }
                } else {
                    currentLossStreak++;
                    currentWinStreak = 0;
                    if (currentLossStreak > longestLossStreak) {
                        longestLossStreak = currentLossStreak;
                    }
                }
            });
            return { currentWinStreak, longestWinStreak, currentLossStreak, longestLossStreak };
        }

        function calculateProjections(targetBalance) {
            projectedGrowthHistory = [];
            let projectedBalance = balanceData.calculatedBalanceUsdt;
            const today = new Date();

            let daysToTarget = 0;
            let reachedTarget = false;
            const maxProjectionCheck = 365 * 10; // Check up to 10 years

            for (let i = 0; i < maxProjectionCheck; i++) {
                if (i < appSettings.projectionPeriodDays) {
                    const futureDate = new Date(today);
                    futureDate.setDate(today.getDate() + i);
                    let balanceForChart = projectedBalance;
                     for (let j = 0; j < appSettings.tradesPerDay; j++) {
                        if (appSettings.selectedProjectionMethod === 'percent') {
                            balanceForChart += balanceForChart * (appSettings.projectedGainPerTrade / 100);
                        } else {
                            balanceForChart += appSettings.projectedTradeAmount * (appSettings.projectedRoiPerTrade / 100);
                        }
                    }
                    projectedGrowthHistory.push({ time: futureDate.toISOString(), balance: balanceForChart });
                }

                if (!reachedTarget) {
                    let tempBalance = projectedBalance;
                    for (let j = 0; j < appSettings.tradesPerDay; j++) {
                        if (appSettings.selectedProjectionMethod === 'percent') {
                            tempBalance += tempBalance * (appSettings.projectedGainPerTrade / 100);
                        } else {
                            tempBalance += appSettings.projectedTradeAmount * (appSettings.projectedRoiPerTrade / 100);
                        }
                        if (tempBalance >= targetBalance) {
                            daysToTarget = i + ((j + 1) / appSettings.tradesPerDay);
                            reachedTarget = true;
                            break;
                        }
                    }
                    projectedBalance = tempBalance;
                }
                
                if (i >= appSettings.projectionPeriodDays && reachedTarget) {
                    break;
                }
            }

            return { daysToTarget: reachedTarget ? daysToTarget : Infinity };
        }


        // --- Core Logic ---
        function updateAllMetrics() {
            // Update settings from UI
            appSettings.usdtPhpRate = parseFloat(document.getElementById('usdtPhpRate').value) || DEFAULT_APP_SETTINGS.usdtPhpRate;
            appSettings.targetMonthlyIncomePhp = parseFloat(document.getElementById('targetMonthlyIncomePhp').value) || DEFAULT_APP_SETTINGS.targetMonthlyIncomePhp;
            appSettings.startingBalanceUsdt = parseFloat(document.getElementById('startingBalanceUsdt').value) || DEFAULT_APP_SETTINGS.startingBalanceUsdt;
            appSettings.projectedGainPerTrade = parseFloat(document.getElementById('projectedGainPerTradeInput').value) || DEFAULT_APP_SETTINGS.projectedGainPerTrade;
            appSettings.tradesPerDay = parseInt(document.getElementById('tradesPerDayInput').value) || DEFAULT_APP_SETTINGS.tradesPerDay;
            appSettings.projectionPeriodDays = parseInt(document.getElementById('projectionPeriodDaysInput').value) || DEFAULT_APP_SETTINGS.projectionPeriodDays;
            appSettings.projectedTradeAmount = parseFloat(document.getElementById('projectedTradeAmountInput').value) || DEFAULT_APP_SETTINGS.projectedTradeAmount;
            appSettings.projectedRoiPerTrade = parseFloat(document.getElementById('projectedRoiPerTradeInput').value) || DEFAULT_APP_SETTINGS.projectedRoiPerTrade;
            appSettings.targetTradingVolume = parseFloat(document.getElementById('targetTradingVolumeInput').value) || DEFAULT_APP_SETTINGS.targetTradingVolume;
            balanceData.actualBalanceUsdt = parseFloat(document.getElementById('actualCurrentBalanceUsdtInput').value) || 0;

            // Calculations
            let totalPnL = tradeHistory.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
            balanceData.calculatedBalanceUsdt = appSettings.startingBalanceUsdt + totalPnL;

            const discrepancy = balanceData.actualBalanceUsdt - balanceData.calculatedBalanceUsdt;
            if (tradeHistory.length > 0) {
                discrepancyHistory.push({ time: new Date().toISOString(), value: discrepancy });
                if (discrepancyHistory.length > 100) discrepancyHistory.shift();
            }

            const gainDifference = lastTradeStats.currentGainUsdt - lastTradeStats.previousGainUsdt;
            const tradeAmountGrowth = lastTradeStats.lastTradeAmount - lastTradeStats.previousTradeAmount;

            // Goal Calculations
            const monthlyTargetUsdt = appSettings.targetMonthlyIncomePhp / appSettings.usdtPhpRate;
            const targetBalance = appSettings.startingBalanceUsdt + monthlyTargetUsdt;

            let daysRemainingLinear = Infinity;
            let walletBalanceNeeded = 0;
            let daysToVolumeTarget = Infinity;

            if (tradeHistory.length > 0) {
                const firstTradeDate = new Date(tradeHistory[0].time);
                const daysPassed = Math.max(1, (new Date() - firstTradeDate) / (1000 * 60 * 60 * 24));
                const avgDailyPnl = totalPnL / daysPassed;
                const pnlNeededForTarget = targetBalance - balanceData.calculatedBalanceUsdt;

                if (avgDailyPnl > 0 && pnlNeededForTarget > 0) {
                    daysRemainingLinear = pnlNeededForTarget / avgDailyPnl;
                }

                const avgRoi = tradeHistory.reduce((sum, t) => sum + (t.roi || 0), 0) / tradeHistory.length;
                const today = new Date();
                const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                const daysLeftInMonth = Math.max(1, (endOfMonth - today) / (1000 * 60 * 60 * 24));
                
                const pnlNeededThisMonth = monthlyTargetUsdt - totalPnL;
                if (pnlNeededThisMonth > 0 && avgRoi > 0 && appSettings.tradesPerDay > 0) {
                    const requiredPnlPerDay = pnlNeededThisMonth / daysLeftInMonth;
                    walletBalanceNeeded = (requiredPnlPerDay * 100) / (avgRoi * appSettings.tradesPerDay);
                }
                
                const totalVolume = tradeHistory.reduce((sum, t) => sum + (t.effectiveVolume || 0), 0);
                const avgDailyVolume = totalVolume / daysPassed;
                const volumeNeeded = appSettings.targetTradingVolume - totalVolume;
                if(avgDailyVolume > 0 && volumeNeeded > 0) {
                    daysToVolumeTarget = volumeNeeded / avgDailyVolume;
                }
            }

            const projectionResult = calculateProjections(targetBalance);
            const daysRemainingProjection = projectionResult.daysToTarget;

            // Update UI elements
            document.getElementById('previousBalanceCombined').textContent = formatCombinedCurrency(balanceData.previousBalanceUsdt, appSettings.usdtPhpRate);
            document.getElementById('calculatedBalanceCombined').textContent = formatCombinedCurrency(balanceData.calculatedBalanceUsdt, appSettings.usdtPhpRate);
            document.getElementById('discrepancyCombined').textContent = formatCombinedCurrency(discrepancy, appSettings.usdtPhpRate);
            document.getElementById('discrepancyCombined').className = discrepancy >= 0 ? 'positive' : 'negative';

            document.getElementById('currentGainUsdt').textContent = formatCurrency(lastTradeStats.currentGainUsdt);
            document.getElementById('currentGainPhp').textContent = formatPhp(lastTradeStats.currentGainUsdt * appSettings.usdtPhpRate);
            document.getElementById('currentRoi').textContent = formatDecimalPercentage(lastTradeStats.currentRoi);

            document.getElementById('gainDifferenceUsdt').textContent = formatCurrency(gainDifference);
            document.getElementById('gainDifferenceUsdt').className = gainDifference >= 0 ? 'positive' : 'negative';
            document.getElementById('tradeAmountGrowth').textContent = formatCurrency(tradeAmountGrowth);
            document.getElementById('tradeAmountGrowth').className = tradeAmountGrowth >= 0 ? 'positive' : 'negative';

            const streaks = calculateStreaks();
            let wins = 0, losses = 0;
            tradeHistory.forEach(t => t.pnl >= 0 ? wins++ : losses++);
            document.getElementById('totalWins').textContent = wins;
            document.getElementById('totalLosses').textContent = losses;
            document.getElementById('winRate').textContent = formatPercentage(tradeHistory.length > 0 ? (wins / tradeHistory.length) * 100 : 0);
            document.getElementById('currentWinStreak').textContent = streaks.currentWinStreak;
            document.getElementById('longestWinStreak').textContent = streaks.longestWinStreak;
            document.getElementById('currentLossStreak').textContent = streaks.currentLossStreak;
            document.getElementById('longestLossStreak').textContent = streaks.longestLossStreak;

            document.getElementById('goalTargetBalance').textContent = formatCombinedCurrency(targetBalance, appSettings.usdtPhpRate);
            document.getElementById('goalTotalGains').textContent = formatCombinedCurrency(totalPnL, appSettings.usdtPhpRate);
            document.getElementById('goalDaysRemainingLinear').textContent = formatDays(daysRemainingLinear);
            document.getElementById('goalDaysRemainingProjection').textContent = formatDays(daysRemainingProjection);
            document.getElementById('goalWalletBalanceNeeded').textContent = formatCombinedCurrency(walletBalanceNeeded, appSettings.usdtPhpRate);
            document.getElementById('daysRemainingVolumeTarget').textContent = formatDays(daysToVolumeTarget);

            updateCharts();
            saveState();
        }


        function initializeCharts() {
            const commonLineOptions = {
                responsive: true, maintainAspectRatio: false,
                scales: { y: { beginAtZero: false, ticks: { callback: value => value.toFixed(2) + ' USDT' } }, x: { title: { display: true } } },
                plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: ${context.parsed.y.toFixed(2)} USDT` } } }
            };
            
            monthlyPnLChart = new Chart('monthlyPnLChart', { type: 'line', data: { datasets: [{ label: 'Monthly PNL (USDT)', tension: 0.1, fill: false }] }, options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Month' } } } } });
            monthlyVolumeChart = new Chart('monthlyVolumeChart', { type: 'bar', data: { datasets: [{ label: 'Monthly Trade Volume (USDT)' }] }, options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Month' } } } } });
            dailyRoiChart = new Chart('dailyRoiChart', { type: 'line', data: { datasets: [{ label: 'Daily ROI (%)', borderColor: 'rgb(255, 159, 64)', tension: 0.1 }] }, options: { ...commonLineOptions, scales: { y: { ticks: { callback: value => value.toFixed(2) + ' %' } }, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Date' } } } } });
            dailyVolumeChart = new Chart('dailyVolumeChart', { type: 'line', data: { datasets: [{ label: 'Daily Trade Volume (USDT)', borderColor: 'rgb(54, 162, 235)', tension: 0.1 }] }, options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Date' } } } } });
            discrepancyChart = new Chart('discrepancyChart', { type: 'line', data: { datasets: [{ label: 'Balance Discrepancy (USDT)', borderColor: 'rgb(255, 99, 132)', tension: 0.1 }] }, options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Time of Update' } } } } });
            cumulativeBalanceChart = new Chart('cumulativeBalanceChart', { type: 'line', data: { datasets: [{ label: 'Cumulative Balance (USDT)', tension: 0.1, fill: true, backgroundColor: 'rgba(75, 192, 192, 0.2)' }] }, options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Time' } } } } });
            projectedGrowthChart = new Chart('projectedGrowthChart', {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Projected Balance', data: [], borderColor: 'rgb(0, 123, 255)', borderDash: [5, 5], tension: 0.1, pointRadius: 0 },
                        { label: 'Actual Cumulative Balance', data: [], borderColor: 'rgb(40, 167, 69)', tension: 0.1, pointRadius: 3 }
                    ]
                },
                options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Date' } } } }
            });
            
            pnlByDayChart = new Chart('pnlByDayChart', { type: 'bar', data: { datasets: [{ label: 'Total PNL (USDT)' }] }, options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Day of the Week' } } } } });
            pnlByAssetChart = new Chart('pnlByAssetChart', { type: 'bar', data: { datasets: [{ label: 'Total PNL (USDT)', backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Win Rate (%)', type: 'line', yAxisID: 'y1', borderColor: 'rgb(255, 159, 64)', tension: 0.1 }] }, options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { ...commonLineOptions.scales.x.title, text: 'Asset' } }, y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, ticks: { callback: value => value.toFixed(1) + '%' } } } } });
            avgWinLossChart = new Chart('avgWinLossChart', { type: 'bar', data: { datasets: [{ label: 'Average Amount (USDT)' }] }, options: { ...commonLineOptions, scales: { ...commonLineOptions.scales, x: { ...commonLineOptions.scales.x, title: { text: 'Outcome' } } } } });
        }

        function updateCharts() {
            const monthlyData = {};
            const dailyData = {};
            const pnlByDay = { 'Sun': 0, 'Mon': 0, 'Tue': 0, 'Wed': 0, 'Thu': 0, 'Fri': 0, 'Sat': 0 };
            const pnlByAsset = {};
            let totalWinsPnl = 0, winCount = 0, totalLossesPnl = 0, lossCount = 0;
            const dayMap = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

            tradeHistory.forEach(trade => {
                const tradeDate = new Date(trade.time);
                if (isNaN(tradeDate.getTime())) return;
                
                const yearMonth = `${tradeDate.getFullYear()}-${(tradeDate.getMonth() + 1).toString().padStart(2, '0')}`;
                const fullDate = `${yearMonth}-${tradeDate.getDate().toString().padStart(2, '0')}`;
                monthlyData[yearMonth] = monthlyData[yearMonth] || { pnl: 0, volume: 0 };
                monthlyData[yearMonth].pnl += (trade.pnl || 0);
                monthlyData[yearMonth].volume += (trade.effectiveVolume || 0);
                dailyData[fullDate] = dailyData[fullDate] || { pnl: 0, volume: 0, roiSum: 0, roiCount: 0 };
                dailyData[fullDate].pnl += (trade.pnl || 0);
                dailyData[fullDate].volume += (trade.effectiveVolume || 0);
                dailyData[fullDate].roiSum += (trade.roi || 0);
                dailyData[fullDate].roiCount++;

                const dayOfWeek = dayMap[tradeDate.getDay()];
                pnlByDay[dayOfWeek] += (trade.pnl || 0);

                if (!pnlByAsset[trade.pair]) {
                    pnlByAsset[trade.pair] = { pnl: 0, wins: 0, losses: 0 };
                }
                pnlByAsset[trade.pair].pnl += (trade.pnl || 0);
                if ((trade.pnl || 0) >= 0) {
                    pnlByAsset[trade.pair].wins++;
                    totalWinsPnl += trade.pnl;
                    winCount++;
                } else {
                    pnlByAsset[trade.pair].losses++;
                    totalLossesPnl += trade.pnl;
                    lossCount++;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            monthlyPnLChart.data.labels = sortedMonths;
            monthlyPnLChart.data.datasets[0].data = sortedMonths.map(m => monthlyData[m].pnl);
            monthlyVolumeChart.data.labels = sortedMonths;
            monthlyVolumeChart.data.datasets[0].data = sortedMonths.map(m => monthlyData[m].volume);

            const sortedDates = Object.keys(dailyData).sort();
            dailyVolumeChart.data.labels = sortedDates;
            dailyVolumeChart.data.datasets[0].data = sortedDates.map(d => dailyData[d].volume);
            dailyRoiChart.data.labels = sortedDates;
            dailyRoiChart.data.datasets[0].data = sortedDates.map(d => dailyData[d].roiCount > 0 ? dailyData[d].roiSum / dailyData[d].roiCount : 0);

            discrepancyChart.data.labels = discrepancyHistory.map(e => new Date(e.time).toLocaleTimeString());
            discrepancyChart.data.datasets[0].data = discrepancyHistory.map(e => e.value);

            cumulativeBalanceChart.data.labels = cumulativeBalanceHistory.map(e => new Date(e.time).toLocaleString());
            cumulativeBalanceChart.data.datasets[0].data = cumulativeBalanceHistory.map(e => e.balance);

            const actualLabels = cumulativeBalanceHistory.map(e => e.time.split('T')[0]);
            const projectedLabels = projectedGrowthHistory.map(e => e.time.split('T')[0]);
            const combinedLabels = [...new Set([...actualLabels, ...projectedLabels])].sort();
            
            projectedGrowthChart.data.labels = combinedLabels;
            projectedGrowthChart.data.datasets[0].data = combinedLabels.map(date => {
                const entry = projectedGrowthHistory.find(e => e.time.startsWith(date));
                return entry ? entry.balance : null;
            });
            projectedGrowthChart.data.datasets[1].data = combinedLabels.map(date => {
                const entry = cumulativeBalanceHistory.slice().reverse().find(e => e.time.startsWith(date));
                return entry ? entry.balance : null;
            });

            pnlByDayChart.data.labels = Object.keys(pnlByDay);
            pnlByDayChart.data.datasets[0].data = Object.values(pnlByDay);
            pnlByDayChart.data.datasets[0].backgroundColor = Object.values(pnlByDay).map(pnl => pnl >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)');

            const sortedAssets = Object.keys(pnlByAsset).sort((a, b) => pnlByAsset[b].pnl - pnlByAsset[a].pnl);
            pnlByAssetChart.data.labels = sortedAssets;
            pnlByAssetChart.data.datasets[0].data = sortedAssets.map(asset => pnlByAsset[asset].pnl);
            pnlByAssetChart.data.datasets[1].data = sortedAssets.map(asset => {
                const stats = pnlByAsset[asset];
                const total = stats.wins + stats.losses;
                return total > 0 ? (stats.wins / total) * 100 : 0;
            });

            const avgWin = winCount > 0 ? totalWinsPnl / winCount : 0;
            const avgLoss = lossCount > 0 ? totalLossesPnl / lossCount : 0;
            avgWinLossChart.data.labels = ['Average Win', 'Average Loss'];
            avgWinLossChart.data.datasets[0].data = [avgWin, avgLoss];
            avgWinLossChart.data.datasets[0].backgroundColor = ['rgba(75, 192, 192, 0.6)', 'rgba(255, 99, 132, 0.6)'];

            [monthlyPnLChart, monthlyVolumeChart, dailyVolumeChart, dailyRoiChart, discrepancyChart, cumulativeBalanceChart, projectedGrowthChart, pnlByDayChart, pnlByAssetChart, avgWinLossChart].forEach(chart => { if(chart) chart.update() });
        }

        // --- Data Parsing & Handling ---
        function displayTrades(trades) {
            const tradeHistoryOutput = document.getElementById('tradeHistoryOutput');
            tradeHistoryOutput.innerHTML = '';
            if (trades.length === 0) {
                tradeHistoryOutput.innerHTML = '<p class="text-center text-muted m-0">No trade data processed yet.</p>';
                return;
            }
            [...trades].sort((a, b) => new Date(b.time) - new Date(a.time)).forEach(trade => {
                const tradeDiv = document.createElement('div');
                tradeDiv.classList.add('trade-entry');
                tradeDiv.innerHTML = `
                    <div class="d-flex justify-content-between"><span>Pair:</span> <strong>${trade.pair || 'N/A'}</strong></div>
                    <div class="d-flex justify-content-between"><span>Time:</span> <small>${trade.time || 'N/A'}</small></div>
                    <div class="d-flex justify-content-between"><span>PNL:</span> <strong class="${(trade.pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatCurrency(trade.pnl || 0)}</strong></div>
                    <div class="d-flex justify-content-between"><span>ROI:</span> <strong class="${(trade.pnl || 0) >= 0 ? 'positive' : 'negative'}">${formatDecimalPercentage(trade.roi || 0)}</strong></div>
                `;
                tradeHistoryOutput.appendChild(tradeDiv);
            });
        }

        function parseTradeData(rawData) {
            const patterns = {
                pair: /^([A-Z]{2,5}\/[A-Z]{2,5})$/,
                orderNo: /^Order No\.\s*(\d+)$/,
                time: /^Time\s*(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2})$/,
                pnl: /^PNL\s*([+-]?[\d.]+)\s*USDT$/,
                roi: /^ROI\s*≈?\s*([\d.]+)\s*%$/,
                effectiveVolume: /^Effective trading volume\s*([\d.]+)\s*USDT$/
            };
            const tradeBlocks = rawData.replace(/\r\n/g, '\n').split(/\n\n+/);
            const parsedTrades = [];

            tradeBlocks.forEach(block => {
                const trade = {};
                const lines = block.split('\n').map(cleanLine).filter(Boolean);
                lines.forEach(line => {
                    for (const key in patterns) {
                        const match = line.match(patterns[key]);
                        if (match) {
                            trade[key] = key.match(/pnl|roi|effectiveVolume/) ? parseFloat(match[1]) : match[1];
                            return;
                        }
                    }
                });
                if (trade.pair && trade.time && trade.orderNo && !isNaN(trade.pnl)) {
                    parsedTrades.push(trade);
                }
            });
            return parsedTrades;
        }

        function handleNewParsedTrades(newTrades) {
            const existingOrderNos = new Set(tradeHistory.map(t => t.orderNo));
            const uniqueNewTrades = newTrades.filter(t => !existingOrderNos.has(t.orderNo));

            if (uniqueNewTrades.length > 0) {
                const lastNewTrade = uniqueNewTrades[uniqueNewTrades.length - 1];
                if(lastNewTrade.pnl > 0) playSound('win');
                if(lastNewTrade.pnl < 0) playSound('loss');

                lastTradeStats.previousGainUsdt = lastTradeStats.currentGainUsdt;
                lastTradeStats.previousTradeAmount = lastTradeStats.lastTradeAmount;
                balanceData.previousBalanceUsdt = balanceData.calculatedBalanceUsdt;

                tradeHistory.push(...uniqueNewTrades);
                tradeHistory.sort((a, b) => new Date(a.time) - new Date(b.time));

                const latestTradeInHistory = tradeHistory[tradeHistory.length - 1];
                if(latestTradeInHistory) {
                    Object.assign(lastTradeStats, { 
                        currentGainUsdt: latestTradeInHistory.pnl || 0, 
                        currentRoi: latestTradeInHistory.roi || 0, 
                        lastTradeAmount: latestTradeInHistory.effectiveVolume || 0 
                    });
                }
                
                let runningBalance = appSettings.startingBalanceUsdt;
                cumulativeBalanceHistory = tradeHistory.map(trade => {
                    runningBalance += (trade.pnl || 0);
                    return { time: trade.time, balance: runningBalance };
                });

                document.getElementById('tradeDataInput').value = '';
                displayTrades(tradeHistory);
                updateAllMetrics();
            } else {
                alert("No new trades found. The pasted data might be duplicates.");
            }
        }

        // --- Guided Tour ---
        function setupTour() {
            tour = new Shepherd.Tour({
                useModalOverlay: true,
                defaultStepOptions: {
                    classes: 'shadow-md bg-body-tertiary',
                    scrollTo: true
                }
            });
            tour.addStep({ title: 'Welcome!', text: 'This is a quick tour of your dashboard. Let\'s get you set up.', buttons: [{ text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Step 1: Financial Settings', text: 'First, enter your starting balance, target income, and the current USDT/PHP rate here.', attachTo: { element: '#financialGoalsCard', on: window.innerWidth < 768 ? 'bottom' : 'top' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Step 2: Add Your Trades', text: 'Now, paste your trade history into this box. You can also import a previous backup file.', attachTo: { element: '#dataInputCard', on: window.innerWidth < 768 ? 'bottom' : 'right' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Next', action: tour.next }] });
            tour.addStep({ title: 'Step 3: Update Your Balance', text: 'Finally, enter your actual current wallet balance here. The dashboard will calculate any discrepancy for you.', attachTo: { element: '#balanceOverviewCard', on: 'bottom' }, buttons: [{ text: 'Back', action: tour.back }, { text: 'Done', action: tour.complete }] });
            tour.on('complete', () => localStorage.setItem('hasSeenTour', 'true'));
        }

        // --- Data I/O ---
        function resetAllData() { if (confirm("Are you sure you want to reset all data? This cannot be undone.")) { localStorage.clear(); window.location.reload(); } }
        function exportData() {
            const allData = JSON.parse(localStorage.getItem('tradeTrackerData'));
            if (!allData || !allData.tradeHistory || allData.tradeHistory.length === 0) {
                alert("No data available to export.");
                return;
            }
            const dataStr = JSON.stringify(allData, null, 2);
            const dataBlob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trade_tracker_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        if (importedData && typeof importedData === 'object' && importedData.appSettings && importedData.tradeHistory) {
                            loadState(importedData);
                            saveState();
                            displayTrades(tradeHistory);
                            updateAllMetrics();
                            alert("Data imported successfully!");
                        } else {
                            throw new Error("Invalid or corrupted data file.");
                        }
                    } catch (error) {
                        alert("Failed to import data: " + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // --- Fetch exchange rate function ---
        async function fetchExchangeRate() {
            if (appSettings.usdtPhpRate === DEFAULT_APP_SETTINGS.usdtPhpRate) {
                try {
                    const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=php');
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
                    const rate = data.tether.php;
                    if (rate) {
                        appSettings.usdtPhpRate = rate;
                    }
                } catch (error) {
                    console.error("Could not fetch live exchange rate, using default value.", error);
                }
            }
        }

        // --- Main DOMContentLoaded Event Listener ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Event Listeners
            document.querySelectorAll('input[type="number"], select').forEach(el => el.addEventListener('change', updateAllMetrics));
            
            const schedulePlannerInput = document.getElementById('schedulePlannerInput');
            schedulePlannerInput.addEventListener('input', (e) => { appSettings.schedulePlanner = e.target.value; saveState(); });
            
            document.getElementById('projectionMethodSelect').addEventListener('change', (e) => { appSettings.selectedProjectionMethod = e.target.value; toggleProjectionInputs(e.target.value); updateAllMetrics(); });
            document.getElementById('processDataButton').addEventListener('click', () => handleNewParsedTrades(parseTradeData(document.getElementById('tradeDataInput').value)));
            document.getElementById('themeToggle').addEventListener('click', () => { appSettings.theme = appSettings.theme === 'dark' ? 'light' : 'dark'; document.documentElement.setAttribute('data-bs-theme', appSettings.theme); saveState(); });
            document.getElementById('resetDataButtonBottom').addEventListener('click', resetAllData);
            document.getElementById('exportDataButton').addEventListener('click', exportData);
            document.getElementById('importDataButton').addEventListener('click', importData);
            document.getElementById('startTourButton').addEventListener('click', () => tour.start());

            // Collapse State Saving
            document.querySelectorAll('.collapse').forEach(el => {
                el.addEventListener('show.bs.collapse', e => { const card = e.target.closest('.card'); if(card) { cardStates[card.id] = 'expanded'; saveState(); } });
                el.addEventListener('hide.bs.collapse', e => { const card = e.target.closest('.card'); if(card) { cardStates[card.id] = 'collapsed'; saveState(); } });
            });

            // Initial Load Sequence
            initializeCharts();
            setupTour();
            loadState();
            await fetchExchangeRate();
            displayTrades(tradeHistory);
            updateAllMetrics();

            if (!localStorage.getItem('hasSeenTour') && tradeHistory.length === 0) {
                tour.start();
            }

            new Sortable(document.getElementById('card-container'), { animation: 150, handle: '.card-header' });
        });
    </script>
</body>
</html>
